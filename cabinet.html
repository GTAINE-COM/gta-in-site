<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–∞–±—ñ–Ω–µ—Ç ‚Äî GTAINE</title>
  <meta name="description" content="–û—Å–æ–±–∏—Å—Ç–∏–π –∫–∞–±—ñ–Ω–µ—Ç GTAINE" />
  <link rel="stylesheet" href="assets/style.css" />
  <link rel="icon" type="image/svg+xml" href="assets/gtaine-logo.svg">
</head>

<body>
  <!-- TOPBAR -->
  <header class="topbar">
    <div class="container topbar__inner">
      <a class="brand" href="./">
        <img class="brand__badge" src="assets/logo.png" alt="GTAINE">
        <span class="brand__name">
          <span class="brand__title">GTAINE</span>
          <span class="brand__sub">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∏–π RP-–ø—Ä–æ–µ–∫—Ç</span>
        </span>
      </a>

      <div class="navwrap">
        <nav class="nav">
          <a class="nav__link" href="./">–ì–æ–ª–æ–≤–Ω–∞</a>
          <a class="nav__link" href="./forum.html">–§–æ—Ä—É–º</a>
          <a class="nav__link" href="./wiki/">–í—ñ–∫—ñ</a>
          <a class="nav__link" href="./roulette.html">–†—É–ª–µ—Ç–∫–∞</a>
          <a class="nav__link" href="./giveaway.html">–†–æ–∑—ñ–≥—Ä–∞—à</a>
          <a class="nav__link" href="./download.html">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</a>
        </nav>

        <a class="btn btn--ghost is-active" href="./cabinet.html" id="cabBtn">–ö–∞–±—ñ–Ω–µ—Ç</a>
      </div>
    </div>
  </header>

  <main class="page">
    <div class="container">
      <section class="hero hero--tight">
        <div class="hero__card">
          <div class="hero__kicker">GTAINE ‚Ä¢ –ê–ö–ö–ê–£–ù–¢</div>
          <h1 class="hero__title">–û—Å–æ–±–∏—Å—Ç–∏–π –∫–∞–±—ñ–Ω–µ—Ç</h1>
          <p class="hero__text">
            –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è —á–µ—Ä–µ–∑ <b>–ø–æ—à—Ç—É —Ç–∞ –ø–∞—Ä–æ–ª—å</b> —è–∫ —É –≥—Ä—ñ.
          </p>

          <!-- LOGIN CARD -->
          <div class="grid2" id="loginGrid">
            <div class="card">
              <div class="card__title">–í—Ö—ñ–¥</div>

              <label class="field">
                <span class="field__label">–ü–æ—à—Ç–∞</span>
                <input class="field__input" id="email" type="email" placeholder="you@email.com" autocomplete="email">
              </label>

              <label class="field" style="margin-top:10px;">
                <span class="field__label">–ü–∞—Ä–æ–ª—å</span>
                <input class="field__input" id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
              </label>

              <div class="row" style="margin-top:12px;">
                <button class="btn btn--primary" id="loginBtn">–£–≤—ñ–π—Ç–∏</button>
                <button class="btn btn--ghost" id="clearBtn">–û—á–∏—Å—Ç–∏—Ç–∏</button>
              </div>

              <div class="result" id="loginMsg" style="margin-top:12px;">–í–≤–µ–¥–∏ –¥–∞–Ω—ñ –¥–ª—è –≤—Ö–æ–¥—É</div>

              <div class="note" style="margin-top:12px;">
                üîí –ü–∞—Ä–æ–ª—å –Ω–µ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –Ω–∞ —Å–∞–π—Ç—ñ. –ü—ñ—Å–ª—è –≤—Ö–æ–¥—É –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –ª–∏—à–µ —Ç–æ–∫–µ–Ω —Å–µ—Å—ñ—ó.
              </div>
            </div>

            <div class="card">
              <div class="card__title">–©–æ –±—É–¥–µ –≤ –∫–∞–±—ñ–Ω–µ—Ç—ñ</div>
              <ul style="margin:0; padding-left:18px; line-height:1.7;">
                <li><b>–ú–æ—î –º–∞–π–Ω–æ</b> (–±—É–¥–∏–Ω–∫–∏, –∞–≤—Ç–æ, –±—ñ–∑–Ω–µ—Å–∏)</li>
                <li><b>–°–ø–∏—Å–æ–∫ Forbes</b> (—Ç–æ–ø –ø–æ –±–∞–ª–∞–Ω—Å—É)</li>
                <li><b>–í—ñ–∫—ñ</b> (—à–≤–∏–¥–∫—ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è)</li>
                <li>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫–∞—É–Ω—Ç—É (—Ä—ñ–≤–µ–Ω—å/–±–∞–ª–∞–Ω—Å/—Ñ—Ä–∞–∫—Ü—ñ—è)</li>
              </ul>
            </div>
          </div>

          <!-- PROFILE -->
          <div class="grid2" id="profileGrid" style="display:none;">
            <div class="card">
              <div class="card__title">–ü—Ä–æ—Ñ—ñ–ª—å</div>

              <div class="balance">
                <div class="balance__num" id="nick">‚Äî</div>
                <div class="balance__sub" id="emailView">‚Äî</div>
              </div>

              <div class="row row--small" style="margin-top:12px;">
                <div class="pill">–ë–∞–ª–∞–Ω—Å: <b id="money">‚Äî</b></div>
                <div class="pill">–†—ñ–≤–µ–Ω—å: <b id="level">‚Äî</b></div>
                <div class="pill">–§—Ä–∞–∫—Ü—ñ—è: <b id="faction">‚Äî</b></div>
              </div>

              <div class="row" style="margin-top:12px;">
                <button class="btn btn--ghost" id="refreshBtn">–û–Ω–æ–≤–∏—Ç–∏</button>
                <button class="btn btn--ghost" id="logoutBtn">–í–∏–π—Ç–∏</button>
              </div>

              <div class="result" id="profileMsg" style="margin-top:12px;">–ì–æ—Ç–æ–≤–æ ‚úÖ</div>
            </div>

            <div class="card">
              <div class="card__title">–®–≤–∏–¥–∫—ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è</div>
              <div class="row row--small">
                <a class="btn btn--ghost" href="./wiki/" target="_blank">–í—ñ–∫—ñ</a>
                <a class="btn btn--ghost" href="./wiki/transports/" target="_blank">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</a>
                <a class="btn btn--ghost" href="./wiki/things/" target="_blank">–ü—Ä–µ–¥–º–µ—Ç–∏</a>
                <a class="btn btn--ghost" href="./roulette.html" target="_blank">–†—É–ª–µ—Ç–∫–∞</a>
              </div>
            </div>
          </div>

          <!-- MY PROPERTY + FORBES -->
          <div class="grid2" id="dataGrid" style="display:none; margin-top:14px;">
            <div class="card">
              <div class="card__title">–ú–æ—î –º–∞–π–Ω–æ</div>
              <div id="property" class="listbox">‚Äî</div>
            </div>

            <div class="card">
              <div class="card__title">Forbes (—Ç–æ–ø –≥—Ä–∞–≤—Ü—ñ–≤)</div>
              <div id="forbes" class="listbox">‚Äî</div>
            </div>
          </div>

        </div>
      </section>
    </div>
  </main>

  <script>
    // =====================
    // –ù–ê–°–¢–†–û–ô–ö–ê API
    // =====================
    const API_BASE = "https://YOUR-API-DOMAIN"; // <-- –ó–ê–ú–Ü–ù–ò –ù–ê –°–í–Ü–ô –î–û–ú–ï–ù API
    const TOKEN_KEY = "gtaine_token";
    const USER_KEY  = "gtaine_user_public";

    // ui
    const cabBtn = document.getElementById('cabBtn');

    const loginGrid = document.getElementById('loginGrid');
    const profileGrid = document.getElementById('profileGrid');
    const dataGrid = document.getElementById('dataGrid');

    const emailEl = document.getElementById('email');
    const passEl  = document.getElementById('password');
    const loginBtn = document.getElementById('loginBtn');
    const clearBtn = document.getElementById('clearBtn');
    const loginMsg = document.getElementById('loginMsg');

    const nickEl = document.getElementById('nick');
    const emailViewEl = document.getElementById('emailView');
    const moneyEl = document.getElementById('money');
    const levelEl = document.getElementById('level');
    const factionEl = document.getElementById('faction');
    const profileMsg = document.getElementById('profileMsg');

    const propertyBox = document.getElementById('property');
    const forbesBox = document.getElementById('forbes');

    const refreshBtn = document.getElementById('refreshBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    function setMsg(el, text, good=true){
      el.textContent = text;
      el.classList.toggle('result--good', !!good);
      el.classList.toggle('result--bad', !good);
    }

    function getToken(){
      return localStorage.getItem(TOKEN_KEY);
    }
    function setToken(t){
      localStorage.setItem(TOKEN_KEY, t);
    }
    function clearToken(){
      localStorage.removeItem(TOKEN_KEY);
    }

    function setPublicUser(u){
      localStorage.setItem(USER_KEY, JSON.stringify(u));
      if(u?.nick) cabBtn.textContent = u.nick;
    }
    function getPublicUser(){
      try { return JSON.parse(localStorage.getItem(USER_KEY) || "null"); }
      catch { return null; }
    }

    async function api(path, opts={}){
      const headers = opts.headers ? {...opts.headers} : {};
      headers["Content-Type"] = "application/json";

      const token = getToken();
      if(token) headers["Authorization"] = "Bearer " + token;

      const res = await fetch(API_BASE + path, { ...opts, headers });
      const text = await res.text();
      let data = null;
      try { data = text ? JSON.parse(text) : null; } catch { data = { raw:text }; }

      if(!res.ok){
        const msg = data?.message || "–ü–æ–º–∏–ª–∫–∞ API";
        throw new Error(msg);
      }
      return data;
    }

    function renderProperty(items){
      if(!items || !items.length){
        propertyBox.innerHTML = "<div class='muted'>–ù–µ–º–∞—î –º–∞–π–Ω–∞</div>";
        return;
      }
      propertyBox.innerHTML = items.map(x => `
        <div class="lbrow">
          <div class="lbtitle">${escapeHtml(x.title)}</div>
          <div class="lbsub">${escapeHtml(x.desc || "")}</div>
        </div>
      `).join("");
    }

    function renderForbes(rows){
      if(!rows || !rows.length){
        forbesBox.innerHTML = "<div class='muted'>–ü–æ—Ä–æ–∂–Ω—å–æ</div>";
        return;
      }
      forbesBox.innerHTML = rows.map((x,i)=>`
        <div class="lbrow">
          <div class="lbtitle">#${i+1} ${escapeHtml(x.nick)}</div>
          <div class="lbsub">–ë–∞–ª–∞–Ω—Å: ${escapeHtml(String(x.money))}</div>
        </div>
      `).join("");
    }

    function showProfile(profile){
      nickEl.textContent = profile.nick || "‚Äî";
      emailViewEl.textContent = profile.email || "‚Äî";
      moneyEl.textContent = profile.money ?? "‚Äî";
      levelEl.textContent = profile.level ?? "‚Äî";
      factionEl.textContent = profile.faction ?? "‚Äî";

      setPublicUser({ nick: profile.nick || "–ö–∞–±—ñ–Ω–µ—Ç" });

      loginGrid.style.display = "none";
      profileGrid.style.display = "";
      dataGrid.style.display = "";

      renderProperty(profile.property || []);
    }

    function showLogin(){
      loginGrid.style.display = "";
      profileGrid.style.display = "none";
      dataGrid.style.display = "none";
      cabBtn.textContent = "–ö–∞–±—ñ–Ω–µ—Ç";
    }

    // html escape
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }

    // =====================
    // EVENTS
    // =====================
    clearBtn.addEventListener('click', ()=>{
      emailEl.value = "";
      passEl.value = "";
      setMsg(loginMsg, "–í–≤–µ–¥–∏ –¥–∞–Ω—ñ –¥–ª—è –≤—Ö–æ–¥—É", true);
    });

    loginBtn.addEventListener('click', async ()=>{
      const email = (emailEl.value || "").trim();
      const password = passEl.value || "";

      if(!email || !password){
        setMsg(loginMsg, "–ó–∞–ø–æ–≤–Ω–∏ –ø–æ—à—Ç—É —ñ –ø–∞—Ä–æ–ª—å", false);
        return;
      }

      loginBtn.disabled = true;
      setMsg(loginMsg, "–ó–∞—Ö–æ–¥–∏–º–æ‚Ä¶", true);

      try{
        const data = await api("/api/login", {
          method:"POST",
          body: JSON.stringify({ email, password })
        });

        setToken(data.token);
        showProfile(data.profile);
        setMsg(profileMsg, "–£—Å–ø—ñ—à–Ω–∏–π –≤—Ö—ñ–¥ ‚úÖ", true);

        // forbes
        const fb = await api("/api/forbes");
        renderForbes(fb.rows);

      }catch(e){
        setMsg(loginMsg, "–ü–æ–º–∏–ª–∫–∞: " + e.message, false);
      }finally{
        loginBtn.disabled = false;
      }
    });

    refreshBtn.addEventListener('click', async ()=>{
      refreshBtn.disabled = true;
      setMsg(profileMsg, "–û–Ω–æ–≤–ª—é—é‚Ä¶", true);
      try{
        const me = await api("/api/me");
        showProfile(me.profile);
        const fb = await api("/api/forbes");
        renderForbes(fb.rows);
        setMsg(profileMsg, "–û–Ω–æ–≤–ª–µ–Ω–æ ‚úÖ", true);
      }catch(e){
        setMsg(profileMsg, "–ü–æ–º–∏–ª–∫–∞: " + e.message, false);
      }finally{
        refreshBtn.disabled = false;
      }
    });

    logoutBtn.addEventListener('click', async ()=>{
      logoutBtn.disabled = true;
      try{
        // –Ω–µ –æ–±–æ–≤'—è–∑–∫–æ–≤–æ, –∞–ª–µ –∫—Ä–∞—Å–∏–≤–æ
        try { await api("/api/logout", { method:"POST" }); } catch {}
      }finally{
        clearToken();
        localStorage.removeItem(USER_KEY);
        showLogin();
        logoutBtn.disabled = false;
      }
    });

    // =====================
    // INIT
    // =====================
    (async function init(){
      const pu = getPublicUser();
      if(pu?.nick) cabBtn.textContent = pu.nick;

      if(!getToken()){
        showLogin();
        return;
      }

      // —î —Ç–æ–∫–µ–Ω ‚Äî –ø—Ä–æ–±—É—î–º–æ –≤–∑—è—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å
      try{
        const me = await api("/api/me");
        showProfile(me.profile);
        const fb = await api("/api/forbes");
        renderForbes(fb.rows);
      }catch{
        // —Ç–æ–∫–µ–Ω –∑–¥–æ—Ö ‚Äî –Ω–∞–∑–∞–¥ –Ω–∞ –ª–æ–≥—ñ–Ω
        clearToken();
        showLogin();
      }
    })();
  </script>

  <style>
    /* –º–∞–ª–µ–Ω—å–∫—ñ —Å—Ç–∏–ª—ñ –¥–ª—è —Å–ø–∏—Å–∫—ñ–≤, —â–æ–± –≥–∞—Ä–Ω–æ –≤–∏–≥–ª—è–¥–∞–ª–æ –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ style.css –Ω–µ –º–∞—î */
    .pill{ padding:8px 10px; border:1px solid rgba(255,255,255,.08); border-radius:12px; background:rgba(255,255,255,.03); }
    .listbox{ margin-top:8px; display:flex; flex-direction:column; gap:10px; }
    .lbrow{ padding:12px; border-radius:14px; border:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.03); }
    .lbtitle{ font-weight:700; }
    .lbsub{ opacity:.8; margin-top:4px; font-size:14px; }
    .muted{ opacity:.7; padding:10px; }
  </style>
</body>
</html>
